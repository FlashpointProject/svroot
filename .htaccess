Header set Access-Control-Allow-Origin "*"

RewriteEngine On
RewriteBase /

# fix trailing slash problem
RewriteCond %{ENV:REDIRECT_STATUS} ^$
# remove port from host
RewriteCond %{HTTP_HOST} ^([^:]+)
RewriteCond %{DOCUMENT_ROOT}/%1/$1 -d
RewriteRule ^(.*[^/])$ /$1/ [R=301,L]

# rewrite to /<host>/<path>
RewriteCond %{ENV:REDIRECT_STATUS} ^$
RewriteCond %{HTTP_HOST} ^([^:]+)
# do not rewrite if asking for localhost
RewriteCond %1 !^127\.0\.0\.1|localhost$
RewriteRule (.*) /%1/$1 [S=1,E=INITIAL_REQUEST_URI:$1]

# rewrite localhost
RewriteCond %{ENV:REDIRECT_STATUS} ^$
RewriteCond %{HTTP_HOST} ^([^:]+)
RewriteCond %1 ^127\.0\.0\.1|localhost$
RewriteRule (.*) /$1 [E=INITIAL_REQUEST_URI:$1]

RewriteCond %{ENV:REDIRECT_STATUS} ^$
RewriteCond ${DOCUMENT_ROOT}$1/index.html -f
RewriteRule ^/(.*)/$ /$1/index.html [L]

RewriteCond %{ENV:REDIRECT_STATUS} ^$
RewriteCond ${DOCUMENT_ROOT}/$1/index.htm -f
RewriteRule ^/(.*)/$ /$1/index.htm [L]

RewriteCond %{ENV:REDIRECT_STATUS} ^$
RewriteCond ${DOCUMENT_ROOT}/$1/index.php -f
RewriteRule ^/(.*)/$ /$1/index.php [L]

RewriteCond %{ENV:REDIRECT_STATUS} ^$
RewriteCond ${DOCUMENT_ROOT}/$1/index.phtml -f
RewriteRule ^/(.*)/$ /$1/index.phtml [L]

RewriteCond %{ENV:REDIRECT_STATUS} ^$
RewriteCond ${DOCUMENT_ROOT}/$1/index.php5 -f
RewriteRule ^/(.*)/$ /$1/index.php5 [L]

# if rewrite failed, forward to the legacy server
RewriteCond %{ENV:REDIRECT_STATUS} ^.
RewriteCond %{ENV:ALREADY_FORWARDED} ^$
RewriteCond %{REQUEST_FILENAME} !-f
RewriteRule ^ http://10.0.2.2:22600/%{ENV:REDIRECT_INITIAL_REQUEST_URI} [L,P,E=ALREADY_FORWARDED:1]
